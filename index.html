<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vikey Reservations Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      color: #333;
      padding: 1rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    input[type="date"] {
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056cc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background-color: white;
    }

    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th {
      background-color: #f3f4f6;
      font-weight: 600;
      font-size: 0.95rem;
    }

    tr:nth-child(even) td {
      background-color: #fafafa;
    }

    .group-row {
      background-color: #e0f0ff;
      font-weight: bold;
    }

    .group-row td {
      text-align: left !important;
      padding-left: 1rem;
    }

    .subtable td {
      /* padding-left: 2rem; */
      background-color: #f9f9ff;
    }

    #output {
      margin-top: 1.5rem;
    }

    /* Responsive without changing table layout */
    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }

        table {
            font-size: 0.75rem;
            table-layout: fixed;
            word-wrap: break-word;
        }

        th, td {
            padding: 0.4rem;
        }

        th {
            font-size: 0.8rem;
        }
        td {
        word-break: break-word;
        }
    }


  </style>
</head>
<body>
  <div class="container">
    <h1>üìÜ Vikey - Prenotazioni</h1>
    <div class="controls">
      <input type="date" id="dateInput" />
      <!-- <button onclick="getReservations()">Carica Prenotazioni</button> -->
    </div>
    <div id="output">Seleziona una data per visualizzare le prenotazioni.</div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const romeTime = new Date().toLocaleString("en-US", { timeZone: "Europe/Rome" });
      const today = new Date(romeTime);
      const formatted = today.toISOString().split("T")[0];
      document.getElementById("dateInput").value = formatted;
      document.getElementById("dateInput").addEventListener("change", getReservations);
      
      getReservations();
    });

    async function getReservations() {
      const output = document.getElementById("output");
      output.innerHTML = "‚è≥ Caricamento...";

      const selectedDate = document.getElementById("dateInput").value;
      if (!selectedDate) {
        output.textContent = "‚ùó Seleziona una data.";
        return;
      }

      const apiDate = ((selectedDate) => {
        const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Europe/Rome" }));
        now.setDate(now.getDate() - 2);
        const twoDaysAgo = now.toISOString().slice(0, 10);

        // Compare dates as strings (YYYY-MM-DD) works for lexical order:
        if (selectedDate < twoDaysAgo) {
            return selectedDate;
        } else {
            return twoDaysAgo;
        }
        })(selectedDate);

      try {
        const response = await fetch(`https://vikeyserver.onrender.com/reservations?last_updated=${apiDate}`);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.json();

        if (!(result.data && Array.isArray(result.data.reservations))) {
          output.textContent = "‚ö†Ô∏è Nessun dato disponibile.";
          return;
        }

        let reservations = result.data.reservations
          .map(res => {
            const checkIn = `${res.checkin_year}-${String(res.checkin_month).padStart(2, '0')}-${String(res.checkin_day).padStart(2, '0')}`;
            const checkOut = `${res.checkout_year}-${String(res.checkout_month).padStart(2, '0')}-${String(res.checkout_day).padStart(2, '0')}`;
            const stayDays = Math.floor((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
            return {
              room: res.local_name,
              guest: res.guest_name || res.name || "‚Äî",
              numGuests: res.guests_num || 0,
              lang: res.lang === "it" ? "Italiani" : `Stranieri - ${res.lang || "??"}`,
              stayDays,
              checkInDate: checkIn,
              del: res.DEL
            };
          })
          .filter(res => res.checkInDate === selectedDate && res.del === 0);

        if (reservations.length === 0) {
          output.innerHTML = `<p style="margin-top:1rem;">Nessuna prenotazione trovata per il ${selectedDate}</p>`;
          return;
        }

        const grouped = {};
        for (const res of reservations) {
          if (!grouped[res.guest]) grouped[res.guest] = [];
          grouped[res.guest].push(res);
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>Appartamento</th>
                <th>Ospite</th>
                <th>Num Ospiti</th>
                <th>Lingua</th>
                <th>Giorni</th>
              </tr>
            </thead>
            <tbody>
        `;

        const singleGuests = [];
    const groupedGuests = [];

    for (const guest in grouped) {
    const group = grouped[guest];
    if (group.length === 1) {
        const r = group[0];
        singleGuests.push(`
        <tr>
            <td>${r.room}</td>
            <td>${r.guest}</td>
            <td>${r.numGuests}</td>
            <td>${r.lang}</td>
            <td>${r.stayDays}</td>
        </tr>
        `);
    } else {
        let groupHTML = `
        <tr class="group-row">
            <td colspan="5">${guest} (${group.length} appartamenti)</td>
        </tr>
        `;
        group.forEach(r => {
        groupHTML += `
            <tr class="subtable">
            <td>${r.room}</td>
            <td></td>
            <td>${r.numGuests}</td>
            <td>${r.lang}</td>
            <td>${r.stayDays}</td>
            </tr>
        `;
        });
        groupedGuests.push(groupHTML);
    }
    }

    html += singleGuests.join('') + groupedGuests.join('');


        html += `</tbody></table>`;
        output.innerHTML = html;

      } catch (err) {
        console.error("Error loading reservations:", err);
        output.textContent = "‚ùå Errore durante il caricamento: " + err.message;
      }
    }
  </script>
</body>
</html>
